<!DOCTYPE html>
<html lang="en">
<head>
    {{template "thead" .}}

    <title>数字保险箱</title>
    <!--

    -->
    {{template "tlink" .}}

    <style>
        .lcollapse:after {
            content: "\f078";/** 箭头向下图标*/
            font-family: "Font Awesome\ 5 Free";
            font-weight: 900;
        }
        .lcollapse.collapsed:after {
            content: "\f054";/** 箭头向右图标*/
            font-family: "Font Awesome\ 5 Free";
            font-weight: 900;
        }
    </style>
</head>

<body class="bg03">
    <div class="container">
        {{template "tmenu" .}}

        <div class="row tm-content-row tm-mt-big">
            <div class="tm-col tm-col-big">
                <div class="bg-white tm-block">
                    <div class="row">
                        <div class="col-md-7 col-sm-12">
                            <h2 class="tm-block-title d-inline-block">系统已注册用户<span id="user_badge" class="badge bg-success" style="position: absolute;font-size: 0.75rem;">2</span>
                            </h2>
                        </div>
                        <div class="col-md-5 col-sm-12 text-right">
                            <a href="add-user.html" class="btn btn-small btn-primary">增加新用户</a>
                        </div>
                    </div>
                    <ol id="user_list" class="tm-list-group tm-list-group-alternate-color tm-list-group-pad-big">
                        <li class="tm-list-group-item">
                            *root
                        </li>

                    </ol>
                </div>
            </div>
            <div class="tm-col tm-col-big">
                <div class="bg-white tm-block">
                    <div class="row">
                        <div class="col-6">
                            <h2 class="tm-block-title">编辑用户</h2>
                        </div>

                        <div class="col-md-3 col-sm-12 text-right">
                            <a onclick="btnGet('accounts_start')" class="btn btn-small btn-success">激活</a>
                        </div>
                        <div class="col-md-3 col-sm-12 text-left">
                            <a onclick="btnGet('accounts_stop')" class="btn btn-small btn-default">停用</a>
                        </div>

                    </div>
                    <div class="row" id="accordion">
                        <div class="col-12">
                            <div class="card card-danger">
                                <div class="card-header">
                                    <h4 class="card-title w-100">

                                        <a class="d-block w-100 lcollapse" data-toggle="collapse" href="#collapseOne" aria-expanded="true">
                                            <span id="user_reset" class="fas fa-user-lock col-10">重置root用户的密码</span>
                                        </a>
                                    </h4>
                                </div>
                                <div id="collapseOne" class="collapse show" data-parent="#accordion" style="">
                                    <div class="card-body">

                                        <form name="reset" action="acct_reset" method="post">
                                            <input type="hidden" class="form-control" name="user" id="user_reset_name">
                                            <div class="form-group">
                                                <div class="input-group mb-3">
                                                    <input id="pass0" name="pass0" type="password" class="form-control" placeholder="请输入原密码">
                                                    <div class="input-group-append">
                                                        <div class="input-group-text">
                                                            <span class="fas fa-lock"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="input-group mb-3">
                                                    <input id="pass1" name="pass1" type="password" class="form-control" placeholder="请输入新密码">
                                                    <div class="input-group-append">
                                                        <div class="input-group-text">
                                                            <span class="fas fa-lock"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <div class="input-group mb-3">
                                                    <input id="pass2" name="pass2" type="password" class="form-control" placeholder="请再次输入新密码">
                                                    <div class="input-group-append">
                                                        <div class="input-group-text">
                                                            <span class="fas fa-lock"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-8">
                                                </div>
                                                <!-- /.col -->
                                                <div class="col-4">
                                                    <button type="button" class="btn btn-danger btn-block" onclick="btnSubmit('accounts_reset','reset')">重置密码</button>
                                                </div>
                                                <!-- /.col -->
                                            </div>
                                        </form>
                                    </div>
                                </div><!-- collapseOne -->
                            </div>
                            <div class="card card-success">
                                <div class="card-header">
                                    <h4 class="card-title w-100">
                                        <a class="d-block w-100 collapsed lcollapse" data-toggle="collapse" href="#collapseTwo" aria-expanded="false">
                                            <span id="user_update" class="fas fa-user-edit col-10">更新root用户的信息</span>
                                        </a>
                                    </h4>
                                </div>
                                <div id="collapseTwo" class="collapse" data-parent="#accordion" style="">
                                    <div class="card-body">
                                        <form name="update" action="acct_update" class="tm-signup-form">
                                            <input type="hidden" class="form-control" name="user" id="user_update_name">
                                            <div class="form-group">
                                                <label for="password">*密码验证</label>
                                                <div class="input-group mb-3">
                                                    <input placeholder="******" id="password" name="pass0" type="password" class="form-control validate">
                                                    <div class="input-group-append">
                                                        <div class="input-group-text">
                                                            <span class="fas fa-lock"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label for="user_update_nice">用户昵称</label>
                                                <div class="input-group mb-3">
                                                    <input placeholder="root" id="user_update_nice" name="nice" type="text" class="form-control validate" >
                                                    <div class="input-group-append">
                                                        <div class="input-group-text">
                                                            <span class="fas fa-user"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="user_update_email">邮箱</label>
                                                <div class="input-group mb-3">
                                                    <input placeholder="vulputate@bupt.edu.cn" id="user_update_email" name="email" type="email" class="form-control validate">
                                                    <div class="input-group-append">
                                                        <div class="input-group-text">
                                                            <span class="fas fa-envelope"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="form-group">
                                                <label for="user_update_phone">手机</label>
                                                <div class="input-group mb-3">
                                                    <input placeholder="010-030-0440" id="user_update_phone" name="phone" type="tel" class="form-control validate">
                                                    <div class="input-group-append">
                                                        <div class="input-group-text">
                                                            <span class="fas fa-phone"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-sm-4">
                                                </div>
                                                <div class="col-sm-4 tm-btn-right">
                                                    <button type="button" class="btn btn-primary" onclick="btnSubmit('accounts_update','update')">更新信息
                                                    </button>
                                                </div>

                                                <div class="col-sm-4 tm-btn-left">
                                                    <button type="button" class="btn btn-danger" onclick="btnSubmit('accounts_delete','update')">删除账户
                                                    </button>
                                                </div>
                                            </div>

                                        </form>
                                    </div>
                                </div><!-- collapseTwo -->
                            </div>
                        </div><!-- col -->
                    </div><!-- row -->

                </div>
            </div>
            <div class="tm-col tm-col-small">
                <div class="bg-white tm-block">
                    <div class="row">
                        <div class="col-md-6 col-sm-12 text-left" style="padding:0 2px 0 2px">
                            <h2 class="tm-block-title">我的头像</h2>
                        </div>
                        <div class="col-md-6 col-sm-12 text-right" style="padding:0 2px 0 2px">
                            <a href="defense.html" class="btn btn-danger">防御策略</a>
                        </div>
                    </div>
                    <div class="tm-product-img-dummy mx-auto" style="position: relative">
                        <!--                        <div id="imgContainer" style="margin-top: 10px; position: absolute; z-index: 2"></div>-->
                        <img id="imgDefault" src="upload/profile-image.png" alt="我的头像" style="position: absolute; z-index: 1"  class="img-fluid" onclick="document.getElementById('upload-input').click();">
                    </div>

                    <div style="position: relative;">
                        <!--设置input的position为absolute，使其不按文档流排版，并设置其包裹整个布局 -->
                        <!-- 设置opactity为0，使input变透明 -->
                        <!-- 只接受jpg，gif和png格式 -->
                        <input type="hidden" class="form-control" name="user" id="user_reset_avatar">
                        <input name="img" id="upload-input" style="position: absolute; top: 0; bottom: 0; left: 0;right: 0; opacity: 0;" type="file" accept="image/*" onchange="showImg(this)"  />
                        <!-- 自定义按钮效果 -->
                        <div style="text-align: top; margin-top: 10px; margin-left: 20px">
                            <span style="font-size: 16px;font-weight: bold">更换头像：</span>
                            <img id="upload" src="img/upload2.png" style="width: 40px; height: 40px; vertical-align: middle;" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {{template "tfooter" .}}

    </div>

    {{template "tjs" .}}
    <script>
        $(".navbar ui li a").removeClass("active");
        $("#m_accounts").addClass("active");

        var UserData={}
        function GetAll() {
            $.get("accounts_getall", function (data) {
                if (data.code == "00000") {
                    var str = "";
                    UserData = data
                    for (var num = 0; num < data.rec_num; num++) {

                        if (data.by_user == data.user[num].user_name) {
                            str += "<li class='tm-list-group-item' name='" + num + "'>*" + data.user[num].user_name
                            $("#user_reset_name").val(data.user[num].user_name)
                            $("#user_reset_avatar").val(data.user[num].user_name)
                            $("#user_update_name").val(data.user[num].user_name)
                            $("#user_update_nice").val(data.user[num].user_nice)
                            $("#user_update_email").val(data.user[num].user_email)
                            $("#user_update_phone").val(data.user[num].user_phone)
                            $("#imgDefault").attr("src", data.user[num].user_avatar)
                        } else {
                            str += "<li class='tm-list-group-item'name='" + num + "'>" + data.user[num].user_name
                        }
                        if( data.user[num].user_active != "true")
                            str += "(停用)</li>"
                        else
                            str += "</li>"
                    }
                    document.getElementById("user_list").innerHTML = str;
                    $("#user_badge").text(data.rec_num)
                    $("#user_reset").text("重置" + data.by_user + "用户的密码")
                    $("#user_update").text("更新" + data.by_user + "用户的信息")
                    $(".tm-list-group-item").click(function () {
                        var num = $(this).attr("name")
                        $("#user_reset_name").val(UserData.user[num].user_name)
                        $("#user_reset_avatar").val(UserData.user[num].user_name)
                        $("#user_update_name").val(UserData.user[num].user_name)
                        $("#user_update_nice").val(UserData.user[num].user_nice)
                        $("#user_update_email").val(UserData.user[num].user_email)
                        $("#user_update_phone").val(UserData.user[num].user_phone)
                        $("#user_reset").text("重置" + $(this).text() + "用户的密码")
                        $("#user_update").text("更新" + $(this).text() + "用户的信息")
                        $("#imgDefault").attr("src", data.user[num].user_avatar)
                        $("input[name='pass0']").focus()
                    });
                } else {
                    toastr.info('取用户信息失败:' + JSON.stringify(data))
                }

            });
        }
        GetAll();
        $(function() {
            $("form[name='reset']").validate({
                rules: {
                    pass0: {
                        required: true,
                        minlength: 3
                    },
                    pass1: {
                        required: true,
                        minlength: 3
                    },
                    pass2: {
                        required: true,
                        minlength: 3,
                        equalTo:"#pass1"
                    }
                },
                messages: {
                    pass0: {
                        required: "请输入原密码",
                        minlength: "密码长度不能小于3个字母"
                    },
                    pass1: {
                        required: "请输入新密码",
                        minlength: "密码长度不能小于3个字母"
                    },
                    pass2: {
                        required: "请再次输入新密码",
                        minlength: "密码长度不能小于3个字母",
                        equalTo:"两次输入密码不一致"
                    }
                },
                errorElement: 'span',
                errorPlacement: function (error, element) {
                    error.addClass('invalid-feedback');
                    element.closest('.form-group').append(error);
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass('is-invalid');
                }
            });
            $("form[name='update']").validate({
                rules: {
                    pass0: {
                        required: true,
                        minlength: 3,
                    },
                    nice: {
                        required: true,
                        minlength: 3,
                        //异步验证 开始
                        /*
                        remote: {
                            url: "accounts_username_validate",//发送请求的url地址
                            type: "post", //请求方式
                            dataType: "json",//接收的数据类型
                            data: {
                                username: $("#user_update_name").val()
                            },
                            dataFilter: function (data, type) { //过滤返回结果
                                if (data == "true")
                                    return true;  //true代表用户名还未存在
                                else
                                    return false; //false代表用户名已经存在
                            }
                        }*/
                        //异步验证 结束
                    },
                    email: {
                        required: true,
                        email: true
                    },
                    phone: {
                        required: true,
                        minlength: 11
                    }
                },
                messages: {
                    pass0: {
                        required: "请输入验证密码",
                        minlength: "密码长度不能小于3个字母"
                    },
                    nice: {
                        required: "请输入用户昵称",
                        minlength: "用户昵称不能小于3个字母",
                        //remote: "输入的用户名已经存在"
                    },
                    email: {
                        required: "请输入email",
                        email: "请输入有效邮箱名xx@yy.edu.cn"
                    },
                    phone: {
                        required: "请输入手机号",
                        minlength: "手机号不能小于11个数字"
                    }
                },
                errorElement: 'span',
                errorPlacement: function (error, element) {
                    error.addClass('invalid-feedback');
                    element.closest('.form-group').append(error);
                },
                highlight: function (element, errorClass, validClass) {
                    $(element).addClass('is-invalid');
                },
                unhighlight: function (element, errorClass, validClass) {
                    $(element).removeClass('is-invalid');
                }

            });
        });
        function btnGet(url) {
            $.get(url+"/"+$("input[name='user']").val(),function (data) {
                if (data.code == "00000") {
                    toastr.success('修改成功用户:' + $("input[name='user']").val() + data.msg )
                    if( data.url.length > 0 )
                        setTimeout( "window.location.href='"+data.url+"';", 1500 )
                }
                else {
                    toastr.info('处理失败:' + JSON.stringify(data) )
                }
            });
        }
        function btnSubmit(url,id) {
            var flag = $("form[name='" + id + "']").valid();
            if(!flag){
                //没有通过验证
                return;
            }
            //提交表单
            $.ajax({
                type: 'POST',
                async: false,
                url: url,
                data: $("form[name='" + id + "']").serialize(),
                success: function (data, status) {
                    if (data.code == "00000") {
                        toastr.success('修改成功用户:' + $("input[name='user']").val() + data.msg )
                        GetAll();
                        if( data.url.length > 0 )
                            setTimeout( "window.location.href='"+data.url+"';", 1500 )
                    } else {
                        toastr.info('处理失败:' + JSON.stringify(data) )
                    }
                }
            })
            //可以阻止默认form提交事件event.preventDefault()
        }
    </script>

    <script type="text/javascript" >
        function showImg(obj) {
            //var files = obj.files
            //document.getElementById("imgContainer").innerHTML = getImgsByUrl(files)
            //getImgsByFileReader(document.getElementById("imgContainer"), files)
            check();
            // if (bool == "true"){
            //      postData();
            //  }

        }
        function check() {
            var aa = document.getElementById("upload-input").value.toLowerCase().split('.'); //以“.”分隔上传文件字符串
            // var aa=document.form1.userfile.value.toLowerCase().split('.');//以“.”分隔上传文件字符串

            if(document.getElementById("upload-input").value == "") {
                alert('图片不能为空！');
                return false;
            } else {
                if(aa[aa.length - 1] == 'gif' || aa[aa.length - 1] == 'jpg' || aa[aa.length - 1] == 'bmp' || aa[aa.length - 1] == 'png' || aa[aa.length - 1] == 'jpeg') //判断图片格式
                {
                    var imagSize = document.getElementById("upload-input").files[0].size;
                    //alert("图片大小：" + imagSize + "B")
                    //if(imagSize < 1024 * 1024 * 3)
                    // alert("图片大小在3M以内，为：" + imagSize / (1024 * 1024) + "M");
                    postData();
                    return true;
                } else {
                    alert('请选择格式为*.jpg、*.gif、*.bmp、*.png、*.jpeg 的图片'); //jpg和jpeg格式是一样的只是系统Windows认jpg，Mac OS认jpeg，

                    //二者区别自行百度
                    return false;
                }
            }
        }

        // 使用window.URL.createObjectURL(file)读取file实例并显示图片
        function getImgsByUrl(files) {
            var elements = ''
            for (var i = 0; i < files.length; i++) {
                var url = window.URL.createObjectURL(files[i])
                elements += "<img src='"+ url + "' style='width: 200px; height: 200px; vertical-align: middle;' />"
            }
            return elements
        }

        function postData() {
            var formData = new FormData();
            formData.append("username", $("#user_reset_avatar").val());
            formData.append("file", $("#upload-input")[0].files[0]);
            $.ajax({
                url: "update_userimg",
                type: "post",
                data: formData,
                processData: false, // 告诉jQuery不要去处理发送的数据
                contentType: false, // 告诉jQuery不要去设置Content-Type请求头
                dataType: 'json',
                success: function(data) {
                    if (data.code == "00000") {
                        toastr.success('修改头像用户:' + $("input[name='user']").val() + data.msg)
                        if (data.url.length > 0)
                            setTimeout("window.location.href='" + data.url + "';", 1500)
                    }else {
                        toastr.info('处理失败:' + JSON.stringify(data) )
                    }

                },
                error: function(data) {

                }
            });
        }


    </script>
</body>
</html>